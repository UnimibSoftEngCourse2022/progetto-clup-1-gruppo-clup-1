{% extends 'base.html' %}
{% block title %}
Stores
{% endblock %}

{% block content%}
<h2>{{ store.name }}</h2>
<ul>
    <li>{{ store.address }}</li>
</ul>
<div id="aisle_checkboxes">
    <ul>
    {% for aisle_id in aisle_ids %}
        <li>
            <input type="checkbox" id="{{ aisle_id }}">
            <label for="{{ aisle_id }}">{{ aisle_id }}</label>
        </li>
    {% endfor %}
    </ul>
</div>
<p>Active Pool Length: {{ active_pool_len }}</p>
<br>
<ul>
{% for reservation_id in store_pool_enabled %}
    <li>
        Consume: {{ reservation_id }}
        <input type="button" id="consume_btn_{{ reservation_id }}" value="CONSUME!">
    </li>
{% endfor %}
</ul>
<br>
<input type="button" id="make_reservation_btn"  value="Make Reservation">
<input type="button" id= "delete_reservation_wq" value="Delete Reservation From WQ">
<input type="button" id= "free_btn" value="Free store space">
<script>
    function updateStore() {
        var new_name = $("#name").val();
        var new_address = $("#address").val();
        var new_capacity = $("#capacity").val();
        $.ajax({
            url: "{{ url_for('stores.show_store', store_id=store.id) }}",
            type: "PUT",
            data: {
                csrf_token: '{{ csrf_token() }}',
                name: new_name,
                address: new_address,
                capacity: new_capacity,
            },
            success: function(result) {
                location.reload();
            },
        });
    }
</script>
<div>
    <label for="name">Store name:</label><br>
    <input type="text" id="name" placeholder="ex. Esselunga"><br>
    <label for="address">Store address:</label><br>
    <input type="text" id="address" placeholder="ex. Barzano"><br>
    <label for="capacity">Store capacity:</label><br>
    <input type="text" id="capacity" placeholder="ex. 150"><br>
    <button onclick="updateStore()">Update Store!</button>
</div>
<script>
$("#make_reservation_btn").click(function() {
    $aisle_ids_list = $("#aisle_checkboxes input:checkbox:checked").map(function () {
        return $(this).attr("id");
        }).get();
    $.ajax({
        url: "{{ url_for('stores.make_reservation', store_id=store.id) }}",
        type: "POST",
        data: {
            csrf_token: "{{ csrf_token() }}",
            aisle_ids: JSON.stringify($aisle_ids_list),
        },
    });
}); 

$("#delete_reservation_wq").click(function () {
    $.ajax({
        url: "{{ url_for('stores.delete_reservation_from_waiting_queue', store_id=store.id) }}",
        type: 'DELETE',
        success: function(result) {
            $( "#test" ).append( "Delete Reservation From WQ Success." );
        }
    });
});

$("#free_btn").click(function () {
    $.ajax({
        url: "{{ url_for('stores.free_handler', store_id=store.id) }}",
        type: 'DELETE',
        data: {
            csrf_token: '{{ csrf_token() }}',
        },
        success: function(result) {
            location.reload();
        },
    });
});

{% for reservation_id in active_pool %}
$("#consume_btn_{{ reservation_id }}").click(function () {
    $.ajax({
        url: "{{ url_for('stores.consume_handler', store_id=store.id, reservation_id=reservation_id) }}",
        type: 'DELETE',
        data: {
            csrf_token: '{{ csrf_token() }}',
        },
        success: function (result) {
            location.reload();
        },
    });
});
{% endfor %}
</script>
{% endblock %}
